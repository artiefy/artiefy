# Copilot Instructions for Artiefy

**⚠️ IDIOMA OBLIGATORIO**: Todas las respuestas DEBEN ser en **español**. No usar inglés bajo ninguna circunstancia.
Always respond in Spanish (Responde SIEMPRE en español).

## Architecture Overview

**Artiefy** is a Next.js 16 educational platform for managing courses, live classes, projects, and student interactions. Built with **Next.js App Router** (server-first), **Drizzle ORM** + **Neon PostgreSQL**, and **Clerk** authentication.

### Core Structure

- **`src/app/`**: App Router pages, layouts (dashboard, estudiantes, proyectos, clases-grabadas)
- **`src/components/`**: UI components organized by feature (students, educators, projects, forum)
- **`src/server/`**: Backend logic split into actions, db (Drizzle), queries, services, helpers
- **`src/server/actions/`**: Server actions (with `'use server'`) for mutations with type safety
- **`src/server/queries/`**: Drizzle queries for fetching data server-side
- **`drizzle/`**: ORM schema definition in `schema.ts`

### Data Flow

1. **Server Components** (default) fetch data via Drizzle queries in `src/server/queries/`
2. **Server Actions** in `src/server/actions/` handle mutations (create, update, delete)
3. **Client Components** (`'use client'`) use React hooks for UI state; call server actions via `useTransition`
4. **Clerk** auth via `@clerk/nextjs` - user context available in server components via `currentUser()`

## Code Patterns & Conventions

### Imports & Aliases

```typescript
// Use tilde alias for src/ imports
import { ComponentName } from '~/components/feature/ComponentName';
import { queryFunction } from '~/server/queries/queryFile';
import { serverAction } from '~/server/actions/actionFile';
```

### Component Organization

- **Server components** by default; add `'use client'` only when needing React hooks (state, events)
- Component files use **PascalCase** (e.g., `StudentDashboard.tsx`, `NotificationModal.tsx`)
- Keep folder structure flat if <5 files; use subfolders for feature-heavy areas

### Server Actions Pattern

```typescript
// src/server/actions/feature/actionName.ts
'use server';
import { revalidatePath } from 'next/cache';

export async function createResource(input: InputType) {
  // Validate input, check auth (via currentUser()), call Drizzle
  // Revalidate relevant paths
  revalidatePath('/dashboard');
}
```

### Styling

- **Tailwind CSS 4.2.1** with `prettier-plugin-tailwindcss` (auto-sorts classes)
- 80-char print width (Prettier enforces, configured in `prettier.config.mjs`)
- Use shadcn/ui, Radix UI, Mantine components as base

### Database & Drizzle

- Schema in `src/server/db/schema.ts`; use strict types
- Migrations in `drizzle/migrations/` (auto-generated by `npm run db:generate`)
- Connection pooling via Neon (serverless-friendly)
- Use `POSTGRES_URL_NON_POOLING` in migrations, `POSTGRES_URL` (pooled) for app

## Development Workflows

### Essential Commands

```bash
npm run dev              # Start Next.js dev server (http://localhost:3000)
npm run check           # ESLint + TypeScript check (run before commit)
npm run lint:fix        # Auto-fix ESLint/Prettier issues
npm run db:generate     # Generate Drizzle migration from schema changes
npm run db:push         # Apply pending migrations to dev database
npm run embeddings:regen # Re-generate embeddings script (in scripts/)
npm run typecheck       # TypeScript type-check without emitting
```

### Pre-Commit Workflow

- **Husky + lint-staged** run automatically on commit
- `npm run check` must pass (ESLint strict config + TypeScript)
- Use `next build --debug-prerender` for production builds

### Database Development

1. Modify `src/server/db/schema.ts`
2. Run `npm run db:generate` (creates migration file)
3. Review migration in `drizzle/migrations/`
4. Run `npm run db:push` to apply to dev database
5. Commit schema + migration together

## Critical Rules & Gotchas

### ESLint & Linting

- **ESLint 9.39.2** (strict flat config with type-checking)
- Rules enforce: no unused vars (prefix underscore if intentional: `_unused`), proper imports, react-hooks
- File exclusions: `run-migration.ts`, `.next`, `node_modules`
- **Always run `npm run lint:fix` before committing** — pre-commit hooks enforce this

### Authentication & Secrets

- Clerk integration via `@clerk/nextjs` (proxy.ts middleware)
- Get current user in server: `import { currentUser } from '@clerk/nextjs/server'; const user = await currentUser();`
- **Never expose secrets in client code**; validate via `src/env.ts` schema
- Env vars must pass schema validation at runtime (`.env` file required locally)

### API Routes & Server Actions

- **Prefer Server Actions** over API routes (type-safe, less boilerplate)
- API routes in `src/app/api/` for webhooks or non-JSON responses
- POST/PUT/DELETE in server actions must revalidate paths

### Build & Deployment (Vercel)

- `next build --debug-prerender` for checking Client/Server boundaries
- `reactCompiler: false` in `next.config.mjs` (disabled)
- Serverless functions have body size limit of 100MB (configured for large uploads)
- **Image remotePatterns**: S3 bucket + Clerk asset URLs only
- Speed Insights & Analytics included (`@vercel/speed-insights`)

## File Locations & Key Examples

| Pattern         | Location                       | Example                                          |
| --------------- | ------------------------------ | ------------------------------------------------ |
| Page routes     | `src/app/[feature]/page.tsx`   | `src/app/dashboard/page.tsx` (server by default) |
| Layouts         | `src/app/[feature]/layout.tsx` | `src/app/estudiantes/layout.tsx`                 |
| Server actions  | `src/server/actions/[scope]/`  | `src/server/actions/student/enrollCourse.ts`     |
| Queries         | `src/server/queries/`          | `src/server/queries/getCourseById.ts`            |
| Components      | `src/components/[feature]/`    | `src/components/estudiantes/StudentCard.tsx`     |
| API routes      | `src/app/api/[route]/route.ts` | `src/app/api/projects/invitations/route.ts`      |
| Database schema | `src/server/db/schema.ts`      | All Drizzle table definitions                    |

## Git & Commit Guidelines

- **Conventional Commits**: `feat(scope): message`, `fix(scope): message`, `docs:`, `chore:`, `perf:`
- Example: `feat(proyectos): add project invitations system`
- Config in `git-conventional-commits.yaml`
- **Always run `npm run check` before pushing** (pre-push hook runs typecheck)

## When Modifying Code

1. **New feature?** → Create `/src/server/actions/feature/` + `/src/components/feature/`
2. **Database change?** → Update schema → `npm run db:generate` → review migration
3. **API endpoint?** → Prefer server action in `src/server/actions/` over `src/app/api/`
4. **Styling?** → Use Tailwind + shadcn/ui; Prettier auto-sorts classes
5. **Auth-required page?** → Use `currentUser()` in server component; handle null case
6. **Before committing?** → Run `npm run check && npm run lint:fix`

## External Integrations

- **Clerk**: User management & OAuth (Google, GitHub)
- **Neon PostgreSQL**: Database with pooling via Vercel
- **S3 (AWS SDK 3.x)**: File uploads to `artiefy-upload` bucket
- **OpenAI API**: Embeddings for content search
- **PayU**: Payment processing (Merchant ID, Account ID configured in env)
- **n8n**: Workflow automation (webhooks, integrations)
- **Upstash Redis**: Rate-limiting & cache (via `@upstash/ratelimit`)

## Tips for AI Agents

- **Context7 MCP**: Use for official library docs when learning new patterns
- **Search patterns**: Grep `'use client'` to find interactive components
- **Type safety**: Check `src/env.ts` for environment variable schema
- **Error handling**: Server actions throw errors caught by client `useTransition`
- **Performance**: Favor server fetching over client-side queries (less JavaScript)
- **Revalidation**: Call `revalidatePath()` in server actions after mutations

## Context7 MCP - Documentación Oficial (VSCode GitHub Copilot)

**Regla automática**: Siempre usa **Context7 MCP** para obtener documentación oficial actualizada de librerías sin necesidad de escribir "use context7" en cada prompt.

### ¿Cómo funciona Context7?

Context7 trae documentación actualizada y específica de versión directamente de las fuentes oficiales:

- ✅ Ejemplos de código basados en versiones actuales
- ✅ APIs actualizadas (sin alucinaciones)
- ✅ Respuestas específicas para cada versión de librería

### Tip 1: Add a Rule (Agregar Regla Automática)

Para activar Context7 automáticamente en VSCode GitHub Copilot:

**En VSCode Custom Instructions:**

1. Abre VSCode Settings (Ctrl+,)
2. Busca: `github.copilot.chat.customInstructions`
3. Agrega:

```txt
Always use Context7 MCP when I need library/API documentation, code
generation, setup or configuration steps without me having to explicitly ask.
```

### Tip 2: Use Library ID (Usar ID de Librería)

Incluye el ID de Context7 en tu prompt para saltarte la resolución automática:

**Con ID (más rápido):**

```
Implementar autenticación con /supabase/supabase
Configura Server Actions en /vercel/next.js 16 con TypeScript
```

**Sin ID (auto-resolución):**

```
Cómo configuro middleware en Next.js 15?
Muestra ejemplos de Drizzle ORM con PostgreSQL
```

### Tip 3: Specify a Version (Especificar Versión)

Simplemente menciona la versión en tu prompt y Context7 resolverá la documentación correcta:

**Ejemplos:**

```
Cómo configuro Server Actions en Next.js 16 con TypeScript estricto?
Show me Drizzle ORM v0.45 examples for Neon PostgreSQL pooling
Implementa Tailwind CSS 4.2 utilities con Just-in-Time mode
```

Context7 automáticamente detectará y buscará la versión específica.

### IDs útiles de librerías para Artiefy

| Librería     | ID                          | Versión |
| ------------ | --------------------------- | ------- |
| Next.js      | `/vercel/next.js`           | 16.x    |
| Drizzle ORM  | `/drizzle-team/drizzle-orm` | 0.45.x  |
| React        | `/facebook/react`           | 19.x    |
| TypeScript   | `/microsoft/typescript`     | 5.9.x   |
| Tailwind CSS | `/tailwindlabs/tailwindcss` | 4.2.x   |
| Clerk        | `/clerk/clerk-js`           | 6.x     |
| OpenAI       | `/openai/openai-node`       | 6.x     |
| AWS SDK      | `/aws-sdk/aws-sdk-js`       | v3      |

### Documentación Index Completa

https://context7.com/docs/llms.txt
